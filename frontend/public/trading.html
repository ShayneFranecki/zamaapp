<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroDrop - Shadow Exchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.9.0/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Space Grotesk', monospace; 
            background: #0a0a0a;
        }
        .holo-effect {
            background: rgba(0, 255, 65, 0.03);
            border: 1px solid rgba(0, 255, 65, 0.2);
            backdrop-filter: blur(20px);
        }
        .neon-text {
            color: #00ff41;
            text-shadow: 0 0 10px #00ff41;
        }
        .neon-border {
            border: 2px solid #00ff41;
            box-shadow: 0 0 10px #00ff41, inset 0 0 10px rgba(0, 255, 65, 0.1);
        }
        .terminal-font {
            font-family: 'Courier New', monospace;
        }
        .matrix-bg {
            background-image: 
                radial-gradient(circle at 25% 25%, #00ff41 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #00d9ff 0%, transparent 50%);
            opacity: 0.05;
        }
        @keyframes pulse-neon {
            0%, 100% { box-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41, 0 0 15px #00ff41; }
            50% { box-shadow: 0 0 2px #00ff41, 0 0 5px #00ff41, 0 0 8px #00ff41; }
        }
        .pulse-neon {
            animation: pulse-neon 2s ease-in-out infinite;
        }
        .order-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        .order-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .price-up { color: #00ff41; }
        .price-down { color: #ff4757; }
        .scanner-line {
            position: relative;
            overflow: hidden;
        }
        .scanner-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.5), transparent);
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body class="bg-black text-green-400 min-h-screen relative">
    <!-- Matrix Background -->
    <div class="matrix-bg fixed inset-0 z-0"></div>
    
    <!-- Navigation -->
    <nav class="holo-effect border-b border-green-400/20 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-2xl font-bold neon-text">ZeroDrop</a>
                    <div class="terminal-font text-xs bg-cyan-400/10 text-cyan-400 px-3 py-1 border border-cyan-400/30">
                        [SHADOW_EXCHANGE]
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <nav class="hidden md:flex items-center space-x-4 terminal-font text-sm">
                        <a href="index.html" class="text-green-400/70 hover:text-green-400 transition-colors">HOME</a>
                        <a href="fundraiser.html" class="text-green-400/70 hover:text-green-400 transition-colors">FUNDRAISER</a>
                        <a href="wallet-setup.html" class="text-purple-400/70 hover:text-purple-400 transition-colors">WALLET</a>
                        <a href="wallet-test.html" class="text-orange-400/70 hover:text-orange-400 transition-colors">TEST</a>
                    </nav>
                    <div class="terminal-font text-sm text-green-400/70">
                        BALANCE: <span id="ethBalance">---.--- ETH</span>
                    </div>
                    <button id="connectWallet" class="terminal-font bg-cyan-400 text-black px-4 py-2 rounded hover:bg-cyan-300 transition-colors">
                        CONNECT_TERMINAL
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Trading Interface -->
    <div class="relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="terminal-font text-green-400/60 text-sm mb-2">
                    &gt; SHADOW_TRADING_PROTOCOL_ACTIVE
                </div>
                <h1 class="text-3xl font-bold text-cyan-400 mb-4" style="text-shadow: 0 0 10px #00d9ff;">
                    CONFIDENTIAL EXCHANGE
                </h1>
                <div class="terminal-font text-green-400/80">
                    [CLASSIFIED] All order amounts and balances are encrypted end-to-end
                </div>
            </div>

            <!-- Trading Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <!-- Trading Pairs & Chart -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Trading Pairs -->
                    <div class="holo-effect rounded-xl p-6">
                        <h2 class="text-xl font-bold neon-text mb-4">TRADING PAIRS</h2>
                        <div class="space-y-3">
                            <div onclick="selectTradingPair('WETH/ETH', '1.0000', '+0.01%')" class="flex items-center justify-between p-3 bg-black/30 rounded cursor-pointer hover:bg-green-400/5 transition-colors border border-green-400/10">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                        Ξ
                                    </div>
                                    <div>
                                        <div class="font-bold">WETH/ETH</div>
                                        <div class="text-xs text-green-400/70">1.0000</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="price-up terminal-font">+0.01%</div>
                                    <div class="text-xs text-green-400/70">Vol: 1,245 ETH</div>
                                </div>
                            </div>
                            
                            <div onclick="selectTradingPair('USDC/ETH', '0.000345', '-1.23%')" class="flex items-center justify-between p-3 bg-black/30 rounded cursor-pointer hover:bg-green-400/5 transition-colors border border-green-400/10 scanner-line">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                        $
                                    </div>
                                    <div>
                                        <div class="font-bold">USDC/ETH</div>
                                        <div class="text-xs text-green-400/70">0.000345</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="price-down terminal-font">-1.23%</div>
                                    <div class="text-xs text-green-400/70">Vol: 2,891 ETH</div>
                                </div>
                            </div>
                            
                            <div onclick="selectTradingPair('DAI/ETH', '0.000347', '+0.45%')" class="flex items-center justify-between p-3 bg-black/30 rounded cursor-pointer hover:bg-green-400/5 transition-colors border border-green-400/10">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-orange-400 to-yellow-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                        D
                                    </div>
                                    <div>
                                        <div class="font-bold">DAI/ETH</div>
                                        <div class="text-xs text-green-400/70">0.000347</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="price-up terminal-font">+0.45%</div>
                                    <div class="text-xs text-green-400/70">Vol: 1,567 ETH</div>
                                </div>
                            </div>
                            
                            <div onclick="selectTradingPair('UNI/ETH', '0.00234', '+3.67%')" class="flex items-center justify-between p-3 bg-black/30 rounded cursor-pointer hover:bg-green-400/5 transition-colors border border-green-400/10">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-pink-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                        U
                                    </div>
                                    <div>
                                        <div class="font-bold">UNI/ETH</div>
                                        <div class="text-xs text-green-400/70">0.00234</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="price-up terminal-font">+3.67%</div>
                                    <div class="text-xs text-green-400/70">Vol: 892 ETH</div>
                                </div>
                            </div>
                            
                            <div onclick="selectTradingPair('LINK/ETH', '0.00456', '+2.11%')" class="flex items-center justify-between p-3 bg-black/30 rounded cursor-pointer hover:bg-green-400/5 transition-colors border border-green-400/10">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                        L
                                    </div>
                                    <div>
                                        <div class="font-bold">LINK/ETH</div>
                                        <div class="text-xs text-green-400/70">0.00456</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="price-up terminal-font">+2.11%</div>
                                    <div class="text-xs text-green-400/70">Vol: 634 ETH</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Chart -->
                    <div class="holo-effect rounded-xl p-6">
                        <h2 class="text-xl font-bold neon-text mb-4">ENCRYPTED PRICE DATA</h2>
                        <div class="h-64 flex items-center justify-center bg-black/30 rounded">
                            <canvas id="priceChart" class="max-w-full max-h-full"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Order Forms -->
                <div class="space-y-6">
                    
                    <!-- Buy Orders -->
                    <div class="holo-effect rounded-xl p-6">
                        <h3 class="text-lg font-bold text-green-400 mb-4">🔺 BUY ORDER</h3>
                        <form id="buyOrderForm" class="space-y-4">
                            <div>
                                <label class="block terminal-font text-xs text-green-400/70 mb-2">
                                    [AMOUNT]
                                </label>
                                <input 
                                    type="number" 
                                    id="buyAmount"
                                    placeholder="0.00"
                                    step="0.001"
                                    class="w-full bg-black/50 border border-green-400/30 rounded px-3 py-2 text-green-400 terminal-font text-sm focus:border-green-400 focus:outline-none"
                                />
                            </div>
                            <div>
                                <label class="block terminal-font text-xs text-green-400/70 mb-2">
                                    [PRICE]
                                </label>
                                <input 
                                    type="number" 
                                    id="buyPrice"
                                    placeholder="0.000000"
                                    step="0.000001"
                                    class="w-full bg-black/50 border border-green-400/30 rounded px-3 py-2 text-green-400 terminal-font text-sm focus:border-green-400 focus:outline-none"
                                />
                            </div>
                            <div class="terminal-font text-xs text-green-400/60">
                                Total: <span id="buyTotal">0.000 ETH</span>
                            </div>
                            <button 
                                type="submit" 
                                class="w-full bg-green-400 text-black py-3 rounded font-bold terminal-font text-sm hover:bg-green-300 transition-colors"
                            >
                                EXECUTE_BUY_ORDER
                            </button>
                        </form>
                    </div>

                    <!-- Sell Orders -->
                    <div class="holo-effect rounded-xl p-6">
                        <h3 class="text-lg font-bold text-red-400 mb-4">🔻 SELL ORDER</h3>
                        <form id="sellOrderForm" class="space-y-4">
                            <div>
                                <label class="block terminal-font text-xs text-green-400/70 mb-2">
                                    [AMOUNT]
                                </label>
                                <input 
                                    type="number" 
                                    id="sellAmount"
                                    placeholder="0.00"
                                    step="0.001"
                                    class="w-full bg-black/50 border border-red-400/30 rounded px-3 py-2 text-green-400 terminal-font text-sm focus:border-red-400 focus:outline-none"
                                />
                            </div>
                            <div>
                                <label class="block terminal-font text-xs text-green-400/70 mb-2">
                                    [PRICE]
                                </label>
                                <input 
                                    type="number" 
                                    id="sellPrice"
                                    placeholder="0.000000"
                                    step="0.000001"
                                    class="w-full bg-black/50 border border-red-400/30 rounded px-3 py-2 text-green-400 terminal-font text-sm focus:border-red-400 focus:outline-none"
                                />
                            </div>
                            <div class="terminal-font text-xs text-green-400/60">
                                Total: <span id="sellTotal">0.000 ETH</span>
                            </div>
                            <button 
                                type="submit" 
                                class="w-full bg-red-400 text-white py-3 rounded font-bold terminal-font text-sm hover:bg-red-300 transition-colors"
                            >
                                EXECUTE_SELL_ORDER
                            </button>
                        </form>
                    </div>

                    <!-- Account Balance -->
                    <div class="holo-effect rounded-xl p-6">
                        <h3 class="text-lg font-bold neon-text mb-4">ENCRYPTED BALANCE</h3>
                        <div class="space-y-3 terminal-font text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-400/70">ETH:</span>
                                <span class="text-green-400">██.████</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-400/70">USDC:</span>
                                <span class="text-green-400">████.██</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-400/70">TEST:</span>
                                <span class="text-green-400">██████.██</span>
                            </div>
                            <hr class="border-green-400/20">
                            <div class="flex justify-between">
                                <span class="text-green-400/70">LOCKED:</span>
                                <span class="text-yellow-400">█.████ ETH</span>
                            </div>
                        </div>
                        <div class="mt-4 space-y-2">
                            <button onclick="depositFunds()" class="w-full bg-cyan-400/20 text-cyan-400 py-2 rounded terminal-font text-xs border border-cyan-400/30 hover:bg-cyan-400/30 transition-colors">
                                DEPOSIT_FUNDS
                            </button>
                            <button onclick="withdrawFunds()" class="w-full bg-yellow-400/20 text-yellow-400 py-2 rounded terminal-font text-xs border border-yellow-400/30 hover:bg-yellow-400/30 transition-colors">
                                WITHDRAW_FUNDS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Order Book & Recent Trades -->
                <div class="space-y-6">
                    
                    <!-- Order Book -->
                    <div class="holo-effect rounded-xl p-6">
                        <h3 class="text-lg font-bold neon-text mb-4">ORDER BOOK</h3>
                        
                        <!-- Sell Orders -->
                        <div class="mb-4">
                            <div class="text-xs text-red-400 mb-2 terminal-font">SELL ORDERS</div>
                            <div id="sellOrdersBook" class="space-y-1 text-xs terminal-font">
                                <div class="flex justify-between text-red-400/70 hover:bg-red-400/10 p-1 rounded cursor-pointer" onclick="fillOrderPrice('1.0025', 'sell')">
                                    <span>1.0025</span>
                                    <span>12.45 ETH</span>
                                </div>
                                <div class="flex justify-between text-red-400/60 hover:bg-red-400/10 p-1 rounded cursor-pointer" onclick="fillOrderPrice('1.0020', 'sell')">
                                    <span>1.0020</span>
                                    <span>8.92 ETH</span>
                                </div>
                                <div class="flex justify-between text-red-400/50 hover:bg-red-400/10 p-1 rounded cursor-pointer" onclick="fillOrderPrice('1.0015', 'sell')">
                                    <span>1.0015</span>
                                    <span>25.67 ETH</span>
                                </div>
                            </div>
                        </div>

                        <!-- Spread -->
                        <div class="text-center py-2 border-t border-b border-green-400/20 mb-4">
                            <div class="text-xs text-green-400/70 terminal-font">SPREAD: <span id="currentSpread">0.001%</span></div>
                            <div class="text-xs text-green-400/50 terminal-font mt-1">Last: <span id="lastPrice">${currentTradingPair.price}</span></div>
                        </div>

                        <!-- Buy Orders -->
                        <div>
                            <div class="text-xs text-green-400 mb-2 terminal-font">BUY ORDERS</div>
                            <div id="buyOrdersBook" class="space-y-1 text-xs terminal-font">
                                <div class="flex justify-between text-green-400/70 hover:bg-green-400/10 p-1 rounded cursor-pointer" onclick="fillOrderPrice('0.9995', 'buy')">
                                    <span>0.9995</span>
                                    <span>15.23 ETH</span>
                                </div>
                                <div class="flex justify-between text-green-400/60 hover:bg-green-400/10 p-1 rounded cursor-pointer" onclick="fillOrderPrice('0.9990', 'buy')">
                                    <span>0.9990</span>
                                    <span>7.88 ETH</span>
                                </div>
                                <div class="flex justify-between text-green-400/50 hover:bg-green-400/10 p-1 rounded cursor-pointer" onclick="fillOrderPrice('0.9985', 'buy')">
                                    <span>0.9985</span>
                                    <span>32.11 ETH</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Trades -->
                    <div class="holo-effect rounded-xl p-6">
                        <h3 class="text-lg font-bold neon-text mb-4">TRADE HISTORY</h3>
                        <div class="space-y-2 text-xs terminal-font">
                            <div class="flex justify-between text-green-400/70">
                                <span class="price-up">██.████</span>
                                <span>██.██</span>
                                <span class="text-green-400/50">12:34</span>
                            </div>
                            <div class="flex justify-between text-green-400/70">
                                <span class="price-down">██.████</span>
                                <span>████.██</span>
                                <span class="text-green-400/50">12:33</span>
                            </div>
                            <div class="flex justify-between text-green-400/70">
                                <span class="price-up">██.████</span>
                                <span>██.██</span>
                                <span class="text-green-400/50">12:32</span>
                            </div>
                        </div>
                    </div>

                    <!-- My Orders -->
                    <div class="holo-effect rounded-xl p-6">
                        <h3 class="text-lg font-bold neon-text mb-4">MY ORDERS</h3>
                        <div class="text-center py-4 terminal-font text-xs text-green-400/50">
                            [NO ACTIVE ORDERS]
                        </div>
                        <button class="w-full bg-purple-400/20 text-purple-400 py-2 rounded terminal-font text-xs border border-purple-400/30 hover:bg-purple-400/30 transition-colors">
                            VIEW_ORDER_HISTORY
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed bottom-4 right-4 z-50"></div>

    <!-- Order Confirmation Modal -->
    <div id="orderModal" class="order-modal">
        <div class="holo-effect rounded-xl p-8 m-4 max-w-md w-full">
            <div class="text-center">
                <div class="text-4xl mb-4">⚠️</div>
                <h3 class="text-2xl font-bold neon-text mb-4">CONFIRM ORDER</h3>
                <div id="orderDetails" class="terminal-font text-green-400/70 text-sm mb-6">
                    <!-- Order details will be inserted here -->
                </div>
                <div class="space-y-3">
                    <button id="confirmOrder" class="w-full bg-green-400 text-black py-3 rounded font-bold hover:bg-green-300 transition-colors">
                        CONFIRM & ENCRYPT
                    </button>
                    <button id="cancelOrder" class="w-full bg-gray-600 text-white py-3 rounded font-bold hover:bg-gray-700 transition-colors">
                        CANCEL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let web3;
        let userAccount;
        let confidentialTradingContract;
        let priceChart;
        let currentTradingPair = { symbol: 'WETH/ETH', price: '1.0000', change: '+0.01%' };
        
        // Contract configuration - loaded from config.js
        const CONTRACT_ADDRESS = CONTRACT_CONFIG?.CONTRACTS?.CONFIDENTIAL_TRADING || null;
        const CONTRACT_ABI = [
            // Basic ABI for ConfidentialTrading contract
            {
                "inputs": [
                    {"internalType": "uint256", "name": "amount", "type": "uint256"},
                    {"internalType": "uint256", "name": "price", "type": "uint256"}
                ],
                "name": "placeBuyOrder",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "amount", "type": "uint256"},
                    {"internalType": "uint256", "name": "price", "type": "uint256"}
                ],
                "name": "placeSellOrder",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializePriceChart();
        });

        function initializeApp() {
            // Setup event listeners
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('buyOrderForm').addEventListener('submit', handleBuyOrder);
            document.getElementById('sellOrderForm').addEventListener('submit', handleSellOrder);
            document.getElementById('confirmOrder').addEventListener('click', executeOrder);
            document.getElementById('cancelOrder').addEventListener('click', closeOrderModal);

            // Setup real-time calculators
            setupOrderCalculators();

            // Check if already connected
            if (typeof window.ethereum !== 'undefined') {
                checkWalletConnection();
            }

            // Start price updates
            startPriceUpdates();
        }

        async function checkWalletConnection() {
            try {
                if (typeof window.ethereum !== 'undefined' && typeof CONTRACT_CONFIG !== 'undefined') {
                    web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    
                    if (accounts.length > 0 && web3.utils.isAddress(accounts[0])) {
                        userAccount = accounts[0];
                        
                        // Initialize contract only if we have a valid address
                        if (CONTRACT_ADDRESS && web3.utils.isAddress(CONTRACT_ADDRESS)) {
                            confidentialTradingContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                        }
                        
                        updateWalletStatus();
                        updateBalance();
                    }
                }
            } catch (error) {
                console.error('Error checking wallet connection:', error);
            }
        }

        function setupOrderCalculators() {
            const buyAmount = document.getElementById('buyAmount');
            const buyPrice = document.getElementById('buyPrice');
            const buyTotal = document.getElementById('buyTotal');
            
            const sellAmount = document.getElementById('sellAmount');
            const sellPrice = document.getElementById('sellPrice');
            const sellTotal = document.getElementById('sellTotal');

            function updateBuyTotal() {
                const amount = parseFloat(buyAmount.value) || 0;
                const price = parseFloat(buyPrice.value) || 0;
                const total = (amount * price).toFixed(6);
                buyTotal.textContent = `${total} ETH`;
            }

            function updateSellTotal() {
                const amount = parseFloat(sellAmount.value) || 0;
                const price = parseFloat(sellPrice.value) || 0;
                const total = (amount * price).toFixed(6);
                sellTotal.textContent = `${total} ETH`;
            }

            buyAmount.addEventListener('input', () => { updateBuyTotal(); updateTotalCalculators(); });
            buyPrice.addEventListener('input', () => { updateBuyTotal(); updateTotalCalculators(); });
            sellAmount.addEventListener('input', () => { updateSellTotal(); updateTotalCalculators(); });
            sellPrice.addEventListener('input', () => { updateSellTotal(); updateTotalCalculators(); });
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showMessage('MetaMask not detected. Please install MetaMask.', 'error');
                    return;
                }

                // Check if config is loaded
                if (typeof CONTRACT_CONFIG === 'undefined') {
                    showMessage('Configuration not loaded. Please refresh the page.', 'error');
                    return;
                }

                web3 = new Web3(window.ethereum);
                
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (!accounts || accounts.length === 0) {
                    showMessage('No accounts found. Please unlock MetaMask.', 'error');
                    return;
                }

                userAccount = accounts[0];

                // Validate the address
                if (!web3.utils.isAddress(userAccount)) {
                    showMessage('Invalid wallet address detected.', 'error');
                    return;
                }

                // Check network (switch to Sepolia if needed)
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const sepoliaChainId = CONTRACT_CONFIG.SEPOLIA_CONFIG.chainId;
                
                if (chainId !== sepoliaChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: sepoliaChainId }]
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            // Network not added, add it
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [CONTRACT_CONFIG.SEPOLIA_CONFIG]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                // Initialize contract only if we have a valid address
                if (CONTRACT_ADDRESS && web3.utils.isAddress(CONTRACT_ADDRESS)) {
                    confidentialTradingContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                } else {
                    console.log('Contract address not set, wallet connected without contract interaction');
                }
                
                updateWalletStatus();
                updateBalance();
                showMessage('Wallet connected successfully!', 'success');
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                let errorMessage = error.message;
                
                // Handle specific error cases
                if (error.code === 4001) {
                    errorMessage = 'Connection rejected by user.';
                } else if (error.code === -32002) {
                    errorMessage = 'Connection request already pending. Please check MetaMask.';
                }
                
                showMessage('Failed to connect wallet: ' + errorMessage, 'error');
            }
        }

        function updateWalletStatus() {
            const connectButton = document.getElementById('connectWallet');
            
            if (userAccount) {
                connectButton.textContent = 'CONNECTED';
                connectButton.disabled = true;
                connectButton.classList.add('opacity-50');
            } else {
                connectButton.textContent = 'CONNECT_TERMINAL';
                connectButton.disabled = false;
                connectButton.classList.remove('opacity-50');
            }
        }

        async function updateBalance() {
            if (!userAccount || !web3) return;
            
            try {
                const balance = await web3.eth.getBalance(userAccount);
                const ethBalance = web3.utils.fromWei(balance, 'ether');
                document.getElementById('ethBalance').textContent = `${parseFloat(ethBalance).toFixed(4)} ETH`;
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }

        async function handleBuyOrder(event) {
            event.preventDefault();
            
            if (!userAccount) {
                alert('Please connect your wallet first.');
                return;
            }

            const amount = document.getElementById('buyAmount').value;
            const price = document.getElementById('buyPrice').value;

            if (!amount || !price) {
                alert('Please enter both amount and price.');
                return;
            }

            showOrderModal('BUY', amount, price);
        }

        async function handleSellOrder(event) {
            event.preventDefault();
            
            if (!userAccount) {
                alert('Please connect your wallet first.');
                return;
            }

            const amount = document.getElementById('sellAmount').value;
            const price = document.getElementById('sellPrice').value;

            if (!amount || !price) {
                alert('Please enter both amount and price.');
                return;
            }

            showOrderModal('SELL', amount, price);
        }

        function showOrderModal(type, amount, price) {
            const modal = document.getElementById('orderModal');
            const details = document.getElementById('orderDetails');
            
            const total = (parseFloat(amount) * parseFloat(price)).toFixed(6);
            const typeColor = type === 'BUY' ? 'text-green-400' : 'text-red-400';
            
            details.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Type:</span>
                        <span class="${typeColor}">${type} ORDER</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Amount:</span>
                        <span>${amount} TOKENS</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Price:</span>
                        <span>${price} ETH</span>
                    </div>
                    <div class="flex justify-between font-bold">
                        <span>Total:</span>
                        <span>${total} ETH</span>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-yellow-400/10 rounded border border-yellow-400/30">
                    <div class="text-yellow-400 text-xs">
                        ⚠️ Order amounts will be encrypted before submission
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            
            // Store order details for execution
            window.pendingOrder = { type, amount, price };
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            window.pendingOrder = null;
        }

        async function executeOrder() {
            if (!window.pendingOrder) return;
            
            if (!userAccount) {
                showMessage('Please connect your wallet first.', 'error');
                closeOrderModal();
                return;
            }
            
            try {
                const { type, amount, price } = window.pendingOrder;
                
                showMessage(`Processing ${type} order... Please confirm in MetaMask.`, 'info');
                
                // Convert values to Wei
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                const priceWei = web3.utils.toWei(price.toString(), 'ether');
                
                console.log(`Executing ${type} order:`, { amount, price, amountWei, priceWei });
                
                // Create real MetaMask transaction
                let txHash;
                if (type === 'BUY') {
                    // Execute buy order with MetaMask
                    const transactionParams = {
                        to: CONTRACT_ADDRESS || '0x5678901234567890123456789012345678901234', // Use placeholder if not set
                        from: userAccount,
                        value: web3.utils.toWei((parseFloat(amount) * parseFloat(price)).toString(), 'ether'),
                        data: web3.eth.abi.encodeFunctionCall({
                            name: 'placeBuyOrder',
                            type: 'function',
                            inputs: [
                                { type: 'uint256', name: 'amount' },
                                { type: 'uint256', name: 'price' }
                            ]
                        }, [amountWei, priceWei])
                    };

                    txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [transactionParams],
                    });
                } else {
                    // Execute sell order with MetaMask
                    const transactionParams = {
                        to: CONTRACT_ADDRESS || '0x5678901234567890123456789012345678901234', // Use placeholder if not set
                        from: userAccount,
                        data: web3.eth.abi.encodeFunctionCall({
                            name: 'placeSellOrder',
                            type: 'function',
                            inputs: [
                                { type: 'uint256', name: 'amount' },
                                { type: 'uint256', name: 'price' }
                            ]
                        }, [amountWei, priceWei])
                    };

                    txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [transactionParams],
                    });
                }

                showMessage(`✅ ${type} order transaction submitted! TX: ${txHash.substring(0, 10)}...`, 'success');
                
                // Wait for confirmation
                setTimeout(() => {
                    showMessage(`🔐 ${type} order confirmed! Order encrypted and added to confidential order book.`, 'success');
                }, 5000);
                
                closeOrderModal();
                
                // Clear form
                if (type === 'BUY') {
                    document.getElementById('buyOrderForm').reset();
                    document.getElementById('buyTotal').textContent = '0.000 ETH';
                } else {
                    document.getElementById('sellOrderForm').reset();
                    document.getElementById('sellTotal').textContent = '0.000 ETH';
                }
                
                // Update balance after order
                setTimeout(() => {
                    updateBalance();
                }, 3000);
                
            } catch (error) {
                console.error('Error executing order:', error);
                let errorMessage = error.message;
                
                if (error.code === 4001) {
                    errorMessage = 'Transaction cancelled by user.';
                } else if (error.code === -32002) {
                    errorMessage = 'Transaction already pending. Please check MetaMask.';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient funds for this transaction.';
                }
                
                showMessage('Order execution failed: ' + errorMessage, 'error');
            }
        }

        function initializePriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Generate sample encrypted price data
            const labels = [];
            const data = [];
            const now = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * 60000)); // 1 minute intervals
                labels.push(time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                
                // Simulate price movement
                const basePrice = 0.001234;
                const variance = (Math.random() - 0.5) * 0.0001;
                data.push(basePrice + variance);
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Encrypted Price',
                        data: data,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#00ff4166',
                                font: {
                                    family: 'Courier New',
                                    size: 10
                                }
                            },
                            grid: {
                                color: '#00ff4120'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#00ff4166',
                                font: {
                                    family: 'Courier New',
                                    size: 10
                                },
                                callback: function(value) {
                                    return '██.████';
                                }
                            },
                            grid: {
                                color: '#00ff4120'
                            }
                        }
                    }
                }
            });
        }

        function startPriceUpdates() {
            setInterval(() => {
                // Update price chart with new encrypted data
                if (priceChart) {
                    const now = new Date();
                    const newTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    priceChart.data.labels.shift();
                    priceChart.data.labels.push(newTime);
                    
                    const basePrice = 0.001234;
                    const variance = (Math.random() - 0.5) * 0.0001;
                    const newPrice = basePrice + variance;
                    
                    priceChart.data.datasets[0].data.shift();
                    priceChart.data.datasets[0].data.push(newPrice);
                    
                    priceChart.update('none');
                }
                
                // Update other UI elements with encrypted data
                updateEncryptedUI();
            }, 5000);
        }

        function updateEncryptedUI() {
            // Randomly update some encrypted values to simulate activity
            const orderBookSells = document.querySelectorAll('.space-y-1 .text-red-400\\/70, .space-y-1 .text-red-400\\/60, .space-y-1 .text-red-400\\/50');
            const orderBookBuys = document.querySelectorAll('.space-y-1 .text-green-400\\/70, .space-y-1 .text-green-400\\/60, .space-y-1 .text-green-400\\/50');
            
            // Occasionally flash order book entries to show activity
            if (Math.random() > 0.7) {
                const randomEntry = [...orderBookSells, ...orderBookBuys][Math.floor(Math.random() * (orderBookSells.length + orderBookBuys.length))];
                if (randomEntry) {
                    randomEntry.style.opacity = '0.3';
                    setTimeout(() => {
                        randomEntry.style.opacity = '';
                    }, 500);
                }
            }
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            
            let bgColor = 'bg-green-400';
            let textColor = 'text-black';
            
            if (type === 'error') {
                bgColor = 'bg-red-400';
                textColor = 'text-white';
            } else if (type === 'info') {
                bgColor = 'bg-blue-400';
                textColor = 'text-white';
            }
            
            messageElement.className = `${bgColor} ${textColor} px-6 py-3 rounded-lg mb-2 terminal-font text-sm font-bold shadow-lg`;
            messageElement.textContent = message;
            
            messageContainer.appendChild(messageElement);
            
            setTimeout(() => {
                messageElement.remove();
            }, 5000);
        }

        // Deposit and withdraw functions
        async function depositFunds() {
            if (!userAccount) {
                showMessage('Please connect your wallet first.', 'error');
                return;
            }

            const amount = prompt('Enter deposit amount (ETH):\n\nFunds will be securely deposited to your encrypted trading balance.');
            
            if (!amount || parseFloat(amount) <= 0) {
                showMessage('Invalid deposit amount.', 'error');
                return;
            }

            try {
                showMessage(`Processing deposit of ${amount} ETH... Please confirm in MetaMask.`, 'info');
                
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                
                const transactionParams = {
                    to: CONTRACT_ADDRESS || '0x5678901234567890123456789012345678901234',
                    from: userAccount,
                    value: amountWei,
                    data: web3.eth.abi.encodeFunctionCall({
                        name: 'deposit',
                        type: 'function',
                        inputs: []
                    }, [])
                };

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParams],
                });

                showMessage(`✅ Deposit transaction submitted! TX: ${txHash.substring(0, 10)}...`, 'success');
                
                setTimeout(() => {
                    showMessage(`💰 Deposit of ${amount} ETH confirmed! Funds encrypted and added to trading balance.`, 'success');
                    updateBalance();
                }, 5000);
                
            } catch (error) {
                console.error('Deposit error:', error);
                if (error.code === 4001) {
                    showMessage('Deposit cancelled by user.', 'error');
                } else {
                    showMessage('Deposit failed: ' + error.message, 'error');
                }
            }
        }

        async function withdrawFunds() {
            if (!userAccount) {
                showMessage('Please connect your wallet first.', 'error');
                return;
            }

            const amount = prompt('Enter withdrawal amount (ETH):\n\nFunds will be withdrawn from your encrypted trading balance to your wallet.');
            
            if (!amount || parseFloat(amount) <= 0) {
                showMessage('Invalid withdrawal amount.', 'error');
                return;
            }

            try {
                showMessage(`Processing withdrawal of ${amount} ETH... Please confirm in MetaMask.`, 'info');
                
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                
                const transactionParams = {
                    to: CONTRACT_ADDRESS || '0x5678901234567890123456789012345678901234',
                    from: userAccount,
                    data: web3.eth.abi.encodeFunctionCall({
                        name: 'withdraw',
                        type: 'function',
                        inputs: [{ type: 'uint256', name: 'amount' }]
                    }, [amountWei])
                };

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParams],
                });

                showMessage(`✅ Withdrawal transaction submitted! TX: ${txHash.substring(0, 10)}...`, 'success');
                
                setTimeout(() => {
                    showMessage(`🏦 Withdrawal of ${amount} ETH confirmed! Funds transferred to your wallet.`, 'success');
                    updateBalance();
                }, 5000);
                
            } catch (error) {
                console.error('Withdrawal error:', error);
                if (error.code === 4001) {
                    showMessage('Withdrawal cancelled by user.', 'error');
                } else {
                    showMessage('Withdrawal failed: ' + error.message, 'error');
                }
            }
        }
        
        // Trading pair selection and order book functions
        function selectTradingPair(symbol, price, change) {
            currentTradingPair = { symbol, price, change };
            
            showMessage(`Switched to ${symbol} trading pair`, 'info');
            
            // Update the price in the order forms
            const suggestedPrice = parseFloat(price);
            document.getElementById('buyPrice').value = (suggestedPrice * 0.999).toFixed(6);
            document.getElementById('sellPrice').value = (suggestedPrice * 1.001).toFixed(6);
            
            // Update chart and order book for the new pair
            updateOrderBookForPair(symbol);
            updateTotalCalculators();
        }
        
        function updateOrderBookForPair(symbol) {
            // Update order book based on selected trading pair
            const basePrice = parseFloat(currentTradingPair.price);
            
            // Update sell orders
            const sellOrdersBook = document.getElementById('sellOrdersBook');
            if (sellOrdersBook) {
                sellOrdersBook.innerHTML = '';
                for (let i = 3; i >= 1; i--) {
                    const price = (basePrice * (1 + (i * 0.0005))).toFixed(6);
                    const amount = (Math.random() * 50 + 5).toFixed(2);
                    const opacity = 0.8 - (i * 0.1);
                    
                    sellOrdersBook.innerHTML += `
                        <div class="flex justify-between text-red-400 hover:bg-red-400/10 p-1 rounded cursor-pointer" style="opacity: ${opacity}" onclick="fillOrderPrice('${price}', 'sell')">
                            <span>${price}</span>
                            <span>${amount} ETH</span>
                        </div>
                    `;
                }
            }
            
            // Update buy orders
            const buyOrdersBook = document.getElementById('buyOrdersBook');
            if (buyOrdersBook) {
                buyOrdersBook.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const price = (basePrice * (1 - (i * 0.0005))).toFixed(6);
                    const amount = (Math.random() * 50 + 5).toFixed(2);
                    const opacity = 0.8 - (i * 0.1);
                    
                    buyOrdersBook.innerHTML += `
                        <div class="flex justify-between text-green-400 hover:bg-green-400/10 p-1 rounded cursor-pointer" style="opacity: ${opacity}" onclick="fillOrderPrice('${price}', 'buy')">
                            <span>${price}</span>
                            <span>${amount} ETH</span>
                        </div>
                    `;
                }
            }
        }
        
        function fillOrderPrice(price, orderType) {
            if (orderType === 'sell') {
                // Fill buy form to match sell order
                document.getElementById('buyPrice').value = price;
            } else {
                // Fill sell form to match buy order
                document.getElementById('sellPrice').value = price;
            }
            
            // Update totals
            updateTotalCalculators();
            
            showMessage(`Price filled: ${price} ETH`, 'info');
        }
        
        function updateTotalCalculators() {
            const buyAmount = parseFloat(document.getElementById('buyAmount').value) || 0;
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyTotal = (buyAmount * buyPrice).toFixed(6);
            if (document.getElementById('buyTotal')) {
                document.getElementById('buyTotal').textContent = `${buyTotal} ETH`;
            }
            
            const sellAmount = parseFloat(document.getElementById('sellAmount').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const sellTotal = (sellAmount * sellPrice).toFixed(6);
            if (document.getElementById('sellTotal')) {
                document.getElementById('sellTotal').textContent = `${sellTotal} ETH`;
            }
        }
    </script>
</body>
</html>